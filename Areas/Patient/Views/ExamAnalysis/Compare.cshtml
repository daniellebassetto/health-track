@model ExamComparisonViewModel
@{
    ViewData["Title"] = "Comparar Exames";
}

<div class="exams-header mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div class="header-title">
            <div class="title-icon">
                <i class="bi bi-bar-chart-line"></i>
            </div>
            <div>
                <h2 class="mb-1">Comparar Exames</h2>
                <p class="text-muted mb-0">Selecione os exames para comparar parâmetros e identificar tendências</p>
            </div>
        </div>
        <a asp-area="Patient" asp-controller="Dashboard" asp-action="Index" class="btn btn-primary create-exam-btn">
            <i class="bi bi-arrow-left me-1"></i> Voltar ao Dashboard
        </a>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card analysis-card">
            <div class="card-header d-flex align-items-center">
                <i class="bi bi-list-check me-2"></i>
                <h5 class="mb-0">Selecionar Exames para Comparação</h5>
            </div>
            <div class="card-body">
                @if (!Model.AvailableExams.Any())
                {
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        Nenhum exame encontrado para este paciente.
                        <a asp-area="Patient" asp-controller="Exam" asp-action="Create"
                            asp-route-patientId="@Model.PatientId">
                            Criar primeiro exame
                        </a>
                    </div>
                }
                else if (Model.AvailableExams.Count < 2)
                {
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        São necessários pelo menos 2 exames para fazer uma comparação.
                        <a asp-area="Patient" asp-controller="Exam" asp-action="Create">
                            Criar novo exame
                        </a>
                    </div>
                }
                else
                {
                    <form method="post" asp-action="GenerateComparison" id="comparisonForm">
                        <input type="hidden" asp-for="PatientId" />

                        <div class="comparison-options mb-4">
                            <div class="form-check">
                                <input asp-for="CompareAll" class="form-check-input" type="checkbox"
                                    onchange="toggleExamSelection()">
                                <label asp-for="CompareAll" class="form-check-label">
                                    <strong>Comparar todos os exames</strong>
                                </label>
                            </div>
                        </div>

                        <div id="examSelectionContainer">
                            <h6 class="mb-3">Ou selecione exames específicos:</h6>
                            <div class="row">
                                @for (int i = 0; i < Model.AvailableExams.Count; i++)
                                {
                                    <div class="col-md-6 col-lg-4 mb-3">
                                        <div class="form-check">
                                            <input type="checkbox" name="SelectedExamIds"
                                                value="@Model.AvailableExams[i].ExamId" class="form-check-input exam-checkbox"
                                                id="exam_@Model.AvailableExams[i].ExamId">
                                            <label class="form-check-label exam-card-label"
                                                for="exam_@Model.AvailableExams[i].ExamId">
                                                <div class="exam-card">
                                                    <div class="exam-info">
                                                        <h6 class="exam-name">@Model.AvailableExams[i].ExamName</h6>
                                                        <div class="exam-details">
                                                            <small class="text-muted d-block mb-2">
                                                                <i class="bi bi-calendar3"></i>
                                                                @Model.AvailableExams[i].ExamDate.ToString("dd/MM/yyyy")
                                                            </small>
                                                            @if (!string.IsNullOrEmpty(Model.AvailableExams[i].Laboratory))
                                                            {
                                                                <small class="text-muted d-block mb-2">
                                                                    <i class="bi bi-building"></i>
                                                                    @Model.AvailableExams[i].Laboratory
                                                                </small>
                                                            }
                                                            <small class="text-muted d-block">
                                                                <i class="bi bi-list-ul"></i>
                                                                @Model.AvailableExams[i].ParameterCount parâmetros
                                                            </small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>

                        <div class="form-actions mt-4">
                            <button type="submit" class="btn btn-primary" id="compareBtn" disabled>
                                <i class="bi bi-bar-chart-line"></i> Gerar Comparação
                            </button>
                        </div>

                        <div id="loadingOverlay" style="display: none;">
                            <div class="loading-content">
                                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                                <p class="mt-3 mb-0">Gerando análise comparativa com IA...</p>
                                <small class="text-muted">Isso pode levar alguns segundos</small>
                            </div>
                        </div>
                    </form>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function toggleExamSelection() {
            const compareAll = document.getElementById('CompareAll').checked;
            const container = document.getElementById('examSelectionContainer');
            const checkboxes = document.querySelectorAll('.exam-checkbox');

            if (compareAll) {
                container.style.opacity = '0.5';
                container.style.pointerEvents = 'none';
                checkboxes.forEach(cb => cb.checked = false);
            } else {
                container.style.opacity = '1';
                container.style.pointerEvents = 'auto';
            }
            updateCompareButton();
        }

        function updateCompareButton() {
            const compareAll = document.getElementById('CompareAll').checked;
            const selectedCheckboxes = document.querySelectorAll('.exam-checkbox:checked');
            const compareBtn = document.getElementById('compareBtn');
            const totalExams = document.querySelectorAll('.exam-checkbox').length;

            if (compareAll && totalExams >= 2) {
                compareBtn.disabled = false;
            } else if (!compareAll && selectedCheckboxes.length >= 2) {
                compareBtn.disabled = false;
            } else {
                compareBtn.disabled = true;
            }
        }

        // Inicializar estado
        document.addEventListener('DOMContentLoaded', function () {
            toggleExamSelection();

            // Adicionar listeners aos checkboxes
            document.querySelectorAll('.exam-checkbox').forEach(cb => {
                cb.addEventListener('change', updateCompareButton);
            });

            document.getElementById('CompareAll').addEventListener('change', toggleExamSelection);

            // Mostrar loading ao submeter
            document.getElementById('comparisonForm').addEventListener('submit', function() {
                document.getElementById('loadingOverlay').style.display = 'flex';
            });
        });
    </script>
}